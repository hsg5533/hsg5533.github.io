"use strict";(self.webpackChunkhsg533_web=self.webpackChunkhsg533_web||[]).push([[81],{9081:(e,t,n)=>{n.r(t),n.d(t,{default:()=>f});var o=n(5043),i=n(4284),a=n(579);const s=.6,r=.9,l=10,c=384,d=384,h={r:255,g:255,b:0,a:.3};function m(e){return 1/(1+Math.exp(-e))}function u(e,t,n){return Math.max(t,Math.min(n,e))}function f(){return(0,o.useEffect)((()=>{const e=document.getElementById("video"),t=document.getElementById("overlay"),n=t.getContext("2d",{willReadFrequently:!0}),o=document.createElement("canvas"),a=o.getContext("2d",{willReadFrequently:!0}),f=document.createElement("canvas"),g=f.getContext("2d",{willReadFrequently:!0});let y=null,w=!1,x=!1,p=0,v=0,M=0,b=0,E=null,I=null;const j=()=>{n.clearRect(0,0,t.width,t.height)},k=()=>{if(e.srcObject){for(const t of e.srcObject.getTracks())t.stop();e.srcObject=null}},L=()=>{const n=e.getBoundingClientRect(),{videoWidth:o,videoHeight:i}=e;t.style.position="absolute",t.style.width=`${Math.round(n.width)}px`,t.style.height=`${Math.round(n.height)}px`,t.style.top=`${Math.round(n.top+window.scrollY)}px`,t.style.left=`${Math.round(n.left+window.scrollX)}px`,t.style.pointerEvents="none",t.width!==o&&(t.width=o),t.height!==i&&(t.height=i)},F=async k=>{if(!x)return;y=requestAnimationFrame(F);const L=1e3/Math.max(1,l);if(w||k-p<L)return;p=k,w=!0;let B=null,C=null;const O=performance.now();try{const{videoWidth:l,videoHeight:y}=e,w=Math.round(l/y*d),x=Math.min(1,c/w),p=Math.round(w*x),v=Math.round(d*x),M=Math.floor((c-p)/2),k=Math.floor((d-v)/2),L=l/w,F=y/d,O=t.width/l,A=t.height/y;o.width=c,o.height=d,a.imageSmoothingEnabled=!0,a.fillStyle="rgb(114,114,114)",a.fillRect(0,0,c,d),a.drawImage(e,0,0,l,y,M,k,p,v);const R=await createImageBitmap(o),D=await i.qY.fromImage(R,{tensorFormat:"RGB",tensorLayout:"NCHW",dataType:"float32",norm:{mean:255,bias:0}});if(R.close(),!E||!I)return;const T=performance.now(),$=await E.run({[I]:D});b=performance.now()-T,D.dispose();for(const e of Object.values($)){if(3===e.dims.length&&1===e.dims[0]){const t=Math.max(e.dims[1],e.dims[2]);t>=1e3&&Math.min(e.dims[1],e.dims[2])>=8&&(!B||t>Math.max(B.dims[1],B.dims[2]))&&(B=e)}if(4===e.dims.length&&1===e.dims[0]){const t=e.dims[1],n=e.dims[2],o=e.dims[3];t>=8&&n>=16&&o>=16&&(!C||n*o>C.dims[2]*C.dims[3])&&(C=e)}}if(!B||!C)return;const N=B.dims,q=C.dims,S=await B.getData(),z=await C.getData();B.dispose(),C.dispose();const P=q[1],U=N[1],W=N[2];let H,V,Y;U<=W?(Y=U,V=W,H=(e,t)=>S[t*V+e]):(V=U,Y=W,H=(e,t)=>S[e*Y+t]);const _=e=>{const t=e?5:4,n=Y-t-P;if(n<=0)return[];const o=t+n,i=[];for(let a=0;a<V;a++){let r=H(a,0),l=H(a,1),h=H(a,2),u=H(a,3);r>=0&&r<=1.5&&l>=0&&l<=1.5&&h>=0&&h<=1.5&&u>=0&&u<=1.5&&(r*=c,h*=c,l*=d,u*=d);const f=e?H(a,4):1,g=f>=0&&f<=1?f:m(f);let y=-1e9;for(let e=0;e<n;e++){const n=H(a,t+e);n>y&&(y=n)}const w=g*(y>=0&&y<=1?y:m(y));if(w<s)continue;const x=r-h/2,p=l-u/2,v=r+h/2,M=l+u/2,b=new Float32Array(P);for(let e=0;e<P;e++)b[e]=H(a,o+e);i.push({x1:x,y1:p,x2:v,y2:M,score:w,maskCoefficients:b})}return i},G=_(!1),X=_(!0),J=X.length>G.length?X:G;if(!J.length)return void j();J.sort(((e,t)=>t.score-e.score));const K=J[0],Q=u((K.x1-M)/x,0,w),Z=u((K.y1-k)/x,0,d),ee=u((K.x2-M)/x,0,w),te=u((K.y2-k)/x,0,d),ne=Math.max(0,Math.floor(Q)),oe=Math.max(0,Math.floor(Z)),ie=Math.min(w,Math.floor(ee)),ae=Math.min(d,Math.floor(te)),se=ie-ne+1,re=ae-oe+1,le=ne*L*O,ce=oe*F*A,de=se*L*O,he=re*F*A,me=M+ne*x,ue=k+oe*x,fe=re*x,ge=se*x,ye=q[1],we=q[2],xe=q[3],pe=u(Math.floor(me),0,c),ve=u(Math.floor(ue),0,d),Me=u(Math.ceil(me+ge),0,c),be=u(Math.ceil(ue+fe),0,d),Ee=Me-pe,Ie=be-ve,je=Math.log(r/(1-r)),ke=we*xe,Le=new Uint8Array(se*re),Fe=xe/c,Be=we/d,Ce=Ee/se,Oe=Ie/re;for(let e=0;e<re;e++){const t=(ve+(e+.5)*Oe)*Be,n=u(Math.floor(t),0,we),o=u(n+1,0,we),i=t-Math.floor(t),a=1-i,s=i,r=n*xe,l=o*xe;for(let c=0;c<se;c++){const t=(pe+(c+.5)*Ce)*Fe,n=u(Math.floor(t),0,xe-1),o=u(n+1,0,xe-1),i=t-Math.floor(t),d=1-i,h=d*a,m=i*a,f=d*s,g=i*s,y=r+n,w=r+o,x=l+n,p=l+o;let v=0;for(let e=0;e<ye;e++){const t=e*ke,n=z[t+y],o=z[t+w],i=z[t+x],a=n*h+o*m+i*f+z[t+p]*g;v+=K.maskCoefficients[e]*a}Le[e*se+c]=v>=je?1:0}}const Ae=[];for(let e=1;e<re-1;e++){const t=e*se;for(let n=1;n<se-1;n++){const o=t+n;if(!Le[o])continue;0===(Le[o-1]&Le[o+1]&Le[o-se]&Le[o+se]&Le[o-se-1]&Le[o-se+1]&Le[o+se-1]&Le[o+se+1])&&Ae.push({x:n,y:e})}}Ae.sort(((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x));const Re=[];for(let e=0;e<Ae.length;e++){const t=Ae[e];for(;Re.length>=2;){const e=Re[Re.length-2],n=Re[Re.length-1];if((n.x-e.x)*(t.y-e.y)-(n.y-e.y)*(t.x-e.x)>0)break;Re.pop()}Re.push(t)}const De=[];for(let e=Ae.length-1;e>=0;e--){const t=Ae[e];for(;De.length>=2;){const e=De[De.length-2],n=De[De.length-1];if((n.x-e.x)*(t.y-e.y)-(n.y-e.y)*(t.x-e.x)>0)break;De.pop()}De.push(t)}De.pop(),Re.pop();const Te=Re.concat(De);if(Te.length>=4){const e=Te.slice();e.push(Te[0]);let t=0;for(let n=0;n<e.length-1;n++){const o=e[n],i=e[n+1];t+=Math.hypot(i.x-o.x,i.y-o.y)}t=Math.max(1,t);let o=.01*t,i=null;for(let n=0;n<35;n++){const t=e.length,n=new Uint8Array(t);n[0]=1,n[t-1]=1;const a=[];for(a.push([0,t-1]);a.length;){const[t,i]=a.pop(),s=e[t].x,r=e[t].y,l=e[i].x,c=e[i].y,d=l-s,h=c-r,m=d*d+h*h;let u=-1,f=-1;for(let n=t+1;n<i;n++){const t=e[n].x,o=e[n].y;let i;if(m<=1e-9)i=Math.hypot(t-s,o-r);else{let e=((t-s)*d+(o-r)*h)/m;e<0?e=0:e>1&&(e=1);const n=s+e*d,a=r+e*h;i=Math.hypot(t-n,o-a)}i>f&&(f=i,u=n)}f>o&&-1!==u&&(n[u]=1,a.push([t,u]),a.push([u,i]))}const s=[];for(let o=0;o<t;o++)n[o]&&s.push(e[o]);if(s.pop(),i=s,i.length>4)o*=1.25;else{if(!(i.length<4))break;o*=.8}}if(!i)return;let a=0,s=0;for(let n=0;n<4;n++)a+=i[n].x,s+=i[n].y;a/=4,s/=4;const r=i.slice().sort(((e,t)=>Math.atan2(e.y-s,e.x-a)-Math.atan2(t.y-s,t.x-a)));let l=0,c=1/0;for(let n=0;n<4;n++){const e=r[n].x+r[n].y;e<c&&(c=e,l=n)}const d=r[l],h=r[(l+1)%4],m=r[(l+2)%4],u=[d,h,m,r[(l+3)%4]].map((e=>{const t=ne+e.x,n=oe+e.y;return{x:t*L*O,y:n*F*A}}));j(),n.save(),n.beginPath(),n.moveTo(u[0].x,u[0].y),n.lineTo(u[1].x,u[1].y),n.lineTo(u[2].x,u[2].y),n.lineTo(u[3].x,u[3].y),n.closePath(),n.strokeStyle="rgba(0,255,0,1)",n.lineWidth=4,n.stroke(),n.restore()}f.width=se,f.height=re;const $e=g.createImageData(se,re),Ne=$e.data;for(let e=0;e<se*re;e++){const t=4*e;Le[e]?(Ne[t]=h.r,Ne[t+1]=h.g,Ne[t+2]=h.b,Ne[t+3]=Math.min(255,Math.round(255*h.a))):(Ne[t]=0,Ne[t+1]=0,Ne[t+2]=0,Ne[t+3]=0)}g.putImageData($e,0,0),n.save(),n.imageSmoothingEnabled=!0,n.drawImage(f,le,ce,de,he),n.fillStyle="rgba(0,0,0,0.95)",n.font=`900 ${Math.round(.06*Math.min(t.width,t.height))}px system-ui`,n.textAlign="center",n.textBaseline="middle",n.fillText(`${Math.round(100*K.score)}%`,le+de/2,ce+he/2),n.restore()}catch(A){A instanceof Error&&console.error(A.message)}finally{if(w=!1,M=performance.now()-O,k-v>200){v=k;const e=document.getElementById("status");e&&(e.textContent=`\uc0ac\uc774\ud074 ${M.toFixed(1)}ms / \ucd94\ub860 ${b.toFixed(1)}ms`)}}};return document.getElementById("start").addEventListener("click",(async()=>{try{E||(E=await i.wV.create("best.onnx",{executionProviders:["webgpu","webgl","wasm"],graphOptimizationLevel:"all"}),I=E.inputNames[0]),k(),e.srcObject=await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:{ideal:"environment"},width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:60}}}),await e.play(),L(),window.addEventListener("scroll",L,{passive:!0}),window.addEventListener("resize",L,{passive:!0}),window.addEventListener("orientationchange",L,{passive:!0}),w=!1,x=!0,p=0,y&&cancelAnimationFrame(y),y=requestAnimationFrame(F)}catch(t){t instanceof Error&&console.error(t.message)}})),document.getElementById("stop").addEventListener("click",(()=>{x=!1,y&&cancelAnimationFrame(y),y=null,k(),e.srcObject=null,j(),window.removeEventListener("scroll",L),window.removeEventListener("resize",L),window.removeEventListener("orientationchange",L)})),document.getElementById("switch").addEventListener("click",(async()=>{let t=0;if(!e.srcObject)return;const n=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),o=e.srcObject.getVideoTracks()[0].getSettings().deviceId;if(o){const e=n.findIndex((e=>e.deviceId===o));e>=0&&(t=(e+1)%n.length)}k(),e.srcObject=await navigator.mediaDevices.getUserMedia({audio:!1,video:{deviceId:{exact:n[t].deviceId},width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:60}}}),await e.play(),L()})),()=>{window.removeEventListener("scroll",L),window.removeEventListener("resize",L),window.removeEventListener("orientationchange",L)}}),[]),(0,a.jsxs)("div",{className:"App",children:[(0,a.jsx)("video",{id:"video",playsInline:!0,autoPlay:!0,muted:!0}),(0,a.jsx)("canvas",{id:"overlay"}),(0,a.jsxs)("div",{className:"hud-top",children:[(0,a.jsx)("button",{className:"hud-btn",id:"start",children:"\uc2dc\uc791"}),(0,a.jsx)("button",{className:"hud-btn",id:"stop",children:"\uc815\uc9c0"}),(0,a.jsx)("button",{className:"hud-btn",id:"switch",children:"\uc804\ud658"}),(0,a.jsx)("div",{id:"status"})]})]})}}}]);
//# sourceMappingURL=81.3f15269a.chunk.js.map